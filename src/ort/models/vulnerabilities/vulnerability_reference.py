# SPDX-FileCopyrightText: 2026 Helio Chissini de Castro <heliocastro@gmail.com>
# SPDX-License-Identifier: MIT

from __future__ import annotations

from enum import Enum

from pydantic import BaseModel, ConfigDict, Field

from .cvss2_rating import Cvss2Rating
from .cvss3_rating import Cvss3Rating
from .cvss4_rating import Cvss4Rating


class VulnerabilityReference(BaseModel):
    """
    A data class representing detailed information about a vulnerability obtained from a specific source.

    A single vulnerability can be listed by multiple sources using different scoring systems to denote its severity.
    So when ORT queries different providers for vulnerability information it may well find multiple records for a single
    vulnerability, which could even contain contradicting information. To model this, a [Vulnerability] is associated
    with a list of references; each reference points to the source of the information and has some detailed information
    provided by this source.

    """

    model_config = ConfigDict(
        extra="forbid",
    )

    url: str = Field(
        ...,
        description="The URI pointing to details of the belonging vulnerability.",
    )

    scoring_system: str | None = Field(
        default=None,
        description="The name of the scoring system (like CVSS, EPSS), if any, as reported by the advice provider.",
    )

    severity: str | None = Field(
        default=None,
        description="The severity, if any, this reference assigns to the belonging vulnerability. This "
        'string is supposed to be a qualitative rating like "LOW" or "HIGH".',
    )

    score: float | None = Field(
        default=None,
        description="The (base) score, if any, this reference assigns to the belonging vulnerability. "
        "The meaning of this number depends on the scoring system.",
    )

    vector: str | None = Field(
        default=None,
        description="For CVSS, this is the full vector this reference assigns to the belonging "
        "vulnerability, if any. While the vector usually contains the scoring system as a "
        "prefix, that is not the case for CVSS v2. For EPSS, this is the percentile, which "
        "provides a measure of probability relative to all other scores.",
    )

    @staticmethod
    def get_qualitative_rating(scoring_system: str | None, score: float | None) -> Enum | None:
        """
        Get the qualitative rating for the given scoring system and score.

        Returns the corresponding CVSS rating enum member, or None if the scoring system is unknown
        or the score does not map to any rating.
        """
        if scoring_system is None or score is None:
            return None

        upper = scoring_system.upper()

        for rating_cls in (Cvss2Rating, Cvss3Rating, Cvss4Rating):
            if any(upper.startswith(prefix) for prefix in rating_cls.prefixes()):
                return rating_cls.from_score(score)

        return None
