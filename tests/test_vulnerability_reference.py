# SPDX-FileCopyrightText: 2026 Helio Chissini de Castro <heliocastro@gmail.com>
# SPDX-License-Identifier: MIT

import pytest
from pydantic import ValidationError

from ort.models.vulnerabilities.cvss2_rating import Cvss2Rating
from ort.models.vulnerabilities.cvss3_rating import Cvss3Rating
from ort.models.vulnerabilities.cvss4_rating import Cvss4Rating
from ort.models.vulnerabilities.vulnerability import Vulnerability
from ort.models.vulnerabilities.vulnerability_reference import VulnerabilityReference


class TestVulnerabilityReference:
    def test_minimal_reference(self):
        """Test creating a reference with only the required url field."""
        ref = VulnerabilityReference(url="https://nvd.nist.gov/vuln/detail/CVE-2024-1234")
        if ref.url != "https://nvd.nist.gov/vuln/detail/CVE-2024-1234":
            pytest.fail(f"Expected url to match, got '{ref.url}'")
        if ref.scoring_system is not None:
            pytest.fail(f"Expected scoring_system to be None, got '{ref.scoring_system}'")
        if ref.severity is not None:
            pytest.fail(f"Expected severity to be None, got '{ref.severity}'")
        if ref.score is not None:
            pytest.fail(f"Expected score to be None, got {ref.score}")
        if ref.vector is not None:
            pytest.fail(f"Expected vector to be None, got '{ref.vector}'")

    def test_full_reference(self):
        """Test creating a reference with all fields populated."""
        ref = VulnerabilityReference(
            url="https://nvd.nist.gov/vuln/detail/CVE-2024-1234",
            scoring_system="CVSS:3.1",
            severity="HIGH",
            score=8.5,
            vector="CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H",
        )
        if ref.scoring_system != "CVSS:3.1":
            pytest.fail(f"Expected scoring_system 'CVSS:3.1', got '{ref.scoring_system}'")
        if ref.severity != "HIGH":
            pytest.fail(f"Expected severity 'HIGH', got '{ref.severity}'")
        if ref.score != 8.5:
            pytest.fail(f"Expected score 8.5, got {ref.score}")
        if ref.vector != "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H":
            pytest.fail(f"Expected vector to match, got '{ref.vector}'")

    def test_scoring_system_alias(self):
        """Test that scoringSystem alias maps to scoring_system field."""
        ref = VulnerabilityReference(
            url="https://example.com",
            scoring_system="CVSS2",
        )
        if ref.scoring_system != "CVSS2":
            pytest.fail(f"Expected scoring_system 'CVSS2', got '{ref.scoring_system}'")

    def test_extra_field_forbidden(self):
        """Test that extra fields are rejected."""
        with pytest.raises(ValidationError):
            VulnerabilityReference(
                url="https://example.com",
                unknown="value",
            )


class TestGetQualitativeRating:
    @pytest.mark.parametrize(
        "scoring_system, score, expected",
        [
            ("CVSS2", 3.5, Cvss2Rating.LOW),
            ("CVSSV2", 5.0, Cvss2Rating.MEDIUM),
            ("CVSS_V2", 9.0, Cvss2Rating.HIGH),
            ("CVSS:2", 10.0, Cvss2Rating.HIGH),
        ],
    )
    def test_cvss2_ratings(self, scoring_system, score, expected):
        """Test that CVSS v2 scoring systems return correct ratings."""
        result = VulnerabilityReference.get_qualitative_rating(scoring_system, score)
        if result != expected:
            pytest.fail(f"{scoring_system} score {score}: expected {expected}, got {result}")

    @pytest.mark.parametrize(
        "scoring_system, score, expected",
        [
            ("CVSS3", 2.0, Cvss3Rating.LOW),
            ("CVSSV3", 5.5, Cvss3Rating.MEDIUM),
            ("CVSS_V3", 8.0, Cvss3Rating.HIGH),
            ("CVSS:3", 9.5, Cvss3Rating.CRITICAL),
            ("CVSS:3.1", 8.5, Cvss3Rating.HIGH),
        ],
    )
    def test_cvss3_ratings(self, scoring_system, score, expected):
        """Test that CVSS v3 scoring systems return correct ratings."""
        result = VulnerabilityReference.get_qualitative_rating(scoring_system, score)
        if result != expected:
            pytest.fail(f"{scoring_system} score {score}: expected {expected}, got {result}")

    @pytest.mark.parametrize(
        "scoring_system, score, expected",
        [
            ("CVSS4", 3.0, Cvss4Rating.LOW),
            ("CVSSV4", 5.5, Cvss4Rating.MEDIUM),
            ("CVSS_V4", 8.0, Cvss4Rating.HIGH),
            ("CVSS:4", 10.0, Cvss4Rating.CRITICAL),
            ("CVSS:4.0", 9.8, Cvss4Rating.CRITICAL),
        ],
    )
    def test_cvss4_ratings(self, scoring_system, score, expected):
        """Test that CVSS v4 scoring systems return correct ratings."""
        result = VulnerabilityReference.get_qualitative_rating(scoring_system, score)
        if result != expected:
            pytest.fail(f"{scoring_system} score {score}: expected {expected}, got {result}")

    def test_case_insensitive_scoring_system(self):
        """Test that scoring system matching is case-insensitive."""
        result1 = VulnerabilityReference.get_qualitative_rating("cvss:3.1", 8.5)
        if result1 != Cvss3Rating.HIGH:
            pytest.fail(f"Expected Cvss3Rating.HIGH for 'cvss:3.1', got {result1}")
        result2 = VulnerabilityReference.get_qualitative_rating("Cvss2", 3.5)
        if result2 != Cvss2Rating.LOW:
            pytest.fail(f"Expected Cvss2Rating.LOW for 'Cvss2', got {result2}")

    def test_none_scoring_system(self):
        """Test that None scoring system returns None."""
        result = VulnerabilityReference.get_qualitative_rating(None, 5.0)
        if result is not None:
            pytest.fail(f"Expected None, got {result}")

    def test_none_score(self):
        """Test that None score returns None."""
        result = VulnerabilityReference.get_qualitative_rating("CVSS:3.1", None)
        if result is not None:
            pytest.fail(f"Expected None, got {result}")

    def test_both_none(self):
        """Test that both None returns None."""
        result = VulnerabilityReference.get_qualitative_rating(None, None)
        if result is not None:
            pytest.fail(f"Expected None, got {result}")

    def test_unknown_scoring_system(self):
        """Test that an unknown scoring system returns None."""
        result1 = VulnerabilityReference.get_qualitative_rating("UNKNOWN", 5.0)
        if result1 is not None:
            pytest.fail(f"Expected None for 'UNKNOWN', got {result1}")
        result2 = VulnerabilityReference.get_qualitative_rating("EPSS", 0.5)
        if result2 is not None:
            pytest.fail(f"Expected None for 'EPSS', got {result2}")

    def test_out_of_range_score(self):
        """Test that out-of-range scores return None."""
        result1 = VulnerabilityReference.get_qualitative_rating("CVSS:3.1", -1.0)
        if result1 is not None:
            pytest.fail(f"Expected None for score -1.0, got {result1}")
        result2 = VulnerabilityReference.get_qualitative_rating("CVSS:3.1", 10.1)
        if result2 is not None:
            pytest.fail(f"Expected None for score 10.1, got {result2}")


class TestVulnerability:
    def test_vulnerability_with_references(self):
        """Test creating a Vulnerability with VulnerabilityReference objects."""
        vuln = Vulnerability(
            id="CVE-2024-1234",
            summary="A critical vulnerability.",
            description="Detailed description.",
            references=[
                VulnerabilityReference(
                    url="https://nvd.nist.gov/vuln/detail/CVE-2024-1234",
                    scoring_system="CVSS:3.1",
                    severity="HIGH",
                    score=8.5,
                ),
                VulnerabilityReference(
                    url="https://example.com/CVE-2024-1234",
                    scoring_system="CVSS2",
                    severity="MEDIUM",
                    score=5.0,
                ),
            ],
        )
        if vuln.id != "CVE-2024-1234":
            pytest.fail(f"Expected id 'CVE-2024-1234', got '{vuln.id}'")
        if len(vuln.references) != 2:
            pytest.fail(f"Expected 2 references, got {len(vuln.references)}")
        if vuln.references[0].scoring_system != "CVSS:3.1":
            pytest.fail(f"Expected scoring_system 'CVSS:3.1', got '{vuln.references[0].scoring_system}'")
        if vuln.references[1].score != 5.0:
            pytest.fail(f"Expected score 5.0, got {vuln.references[1].score}")

    def test_vulnerability_minimal(self):
        """Test creating a Vulnerability with only required fields."""
        vuln = Vulnerability(
            id="CVE-2024-5678",
            references=[
                VulnerabilityReference(url="https://example.com/vuln"),
            ],
        )
        if vuln.id != "CVE-2024-5678":
            pytest.fail(f"Expected id 'CVE-2024-5678', got '{vuln.id}'")
        if vuln.summary is not None:
            pytest.fail(f"Expected summary to be None, got '{vuln.summary}'")
        if vuln.description is not None:
            pytest.fail(f"Expected description to be None, got '{vuln.description}'")
        if len(vuln.references) != 1:
            pytest.fail(f"Expected 1 reference, got {len(vuln.references)}")

    def test_vulnerability_missing_id(self):
        """Test that missing id raises ValidationError."""
        with pytest.raises(ValidationError):
            Vulnerability(references=[VulnerabilityReference(url="https://example.com")])

    def test_vulnerability_missing_references(self):
        """Test that missing references raises ValidationError."""
        with pytest.raises(ValidationError):
            Vulnerability(id="CVE-2024-1234")
